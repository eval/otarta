variables:
  CLJ_CONFIG: "./config/ci"

stages:
  - build-and-test
  - release

build:
  stage: build-and-test
  image: clojure:tools-deps-1.9.0.391-alpine
  tags:
    - docker
  before_script:
    - apk --update add make nodejs-npm
  script:
    - printenv CLJ_CONFIG
    - make compile
    - ls -lag .m2/repository
  cache:
    paths:
      - .m2/repository

test:
  stage: build-and-test
  image: clojure:tools-deps-1.9.0.391-alpine
  tags:
    - docker
  before_script:
    - apk --update add make nodejs-npm yarn
    - yarn add websocket
  script:
    - make test
  cache:
    paths:
      - .m2/repository

release:
  stage: release
  image: maven:3-jdk-8-alpine
  tags:
    - docker
  variables:
    MAVEN_CLI_OPTS: "-s .m2/settings.xml --batch-mode"
    MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  before_script:
    - apk --update add make
  script:
    - make mvn-deploy
  only:
    - master
    - tags